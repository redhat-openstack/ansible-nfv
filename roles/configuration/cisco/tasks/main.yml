---
- block:
    - name: Check for configuration variables
      fail:
        msg:
          - "Variables are not defined"
          - "Please, define the following variables - switch_ip, switch_user, switch_pass, server_name, vlan_id"
      when: item == ''
      with_items:
        - "{{ switch_ip }}"
        - "{{ switch_user }}"
        - "{{ switch_pass }}"
        - "{{ server_name }}"
        - "{{ vlan_id }}"
  when: config

- block:
    - name: Check for backup variables
      fail:
        msg:
          - "Variables are not defined"
          - "Please, define the following variables - switch_ip, switch_user, switch_pass"
      when: item == ''
      with_items:
        - "{{ switch_ip }}"
        - "{{ switch_user }}"
        - "{{ switch_pass }}"
  when: backup

- block:
    - name: Check for restore variables
      fail:
        msg:
          - "Variables are not defined"
          - "Please, define the following variables - switch_ip, switch_user, switch_pass, configuration_file"
      when: item == '' and restore
      with_items:
        - "{{ switch_ip }}"
        - "{{ switch_user }}"
        - "{{ switch_pass }}"
        - "{{ configuration_file }}"
  when: restore

- name: Add switch to inventory
  add_host:
    name: "nfv-cisco"
    groups: "switch"
    ansible_host: "{{ switch_ip }}"
    ansible_connection: local

- name: Set credentials
  set_fact:
    credentials:
      host: "{{ switch_ip }}"
      username: "{{ switch_user }}"
      password: "{{ switch_pass }}"
      auth_pass: "{{ switch_pass }}"
      authorize: yes

- name: Verify switch connectivity
  wait_for:
    host: "{{ switch_ip }}"
    port: "22"

- name: Switch configuration
  include_tasks: config.yml
  with_items: "{{ server_name.split(',') }}"
  loop_control:
    loop_var: server_name_item
  when: config
  delegate_to: "{{ groups['switch'] | first }}"

- name: Switch backup_restore
  include_tasks: backup_restore.yml
  when: backup or restore
  delegate_to: "{{ groups['switch'] | first }}"
