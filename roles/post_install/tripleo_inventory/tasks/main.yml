---

  # Flash in-memory inventory in order to recreate
  # the inventory file with the new parameters
- meta: refresh_inventory

- name: Create environment directory
  file:
    path: "{{ environment_dir }}"
    recurse: yes
    state: directory

- name: Add undercloud to host list
  add_host:
    name: "{{ host }}"
    groups: "undercloud,tester"
    ansible_ssh_host: "{{ host }}"
    ansible_ssh_user: "{{ user | default('stack') }}"
    ansible_ssh_private_key_file: "{{ ssh_key | default(omit) }}"
    ansible_ssh_pass: "{{ ssh_pass | default(omit) }}"

- name: Generate Inventory file
  vars:
    ansible_python_interpreter: /usr/bin/python
  template:
    src: 'inventory.j2'
    dest: "{{ environment_dir }}/inventory_{{ host }}"

- name: Generate and set an SSH key if password is used
  include: 'undercloud_pass.yml'
  when: ssh_pass is defined

- name: Create TripleO inventory
  include: overcloud_nodes.yml
  delegate_to: "{{ host }}"

- name: Update ansible.ssh.config for SSH tunneling
  vars:
    ansible_python_interpreter: /usr/bin/python
  template:
    src: 'ansible.ssh.config.j2'
    dest: "{{ environment_dir }}/ansible.ssh.config.{{ host }}"

- name: Link the current environment SSH file
  file:
    src: "{{ environment_dir }}/ansible.ssh.config.{{ host }}"
    dest: "{{ lookup('env', 'PWD') }}/ansible.ssh.config"
    state: link

- name: Generate Inventory file
  vars:
    ansible_python_interpreter: /usr/bin/python
  template:
    src: 'inventory.j2'
    dest: "{{ environment_dir }}/inventory_{{ host }}"

- name: Link the current environment inventory file
  file:
    src: "{{ environment_dir }}/inventory_{{ host }}"
    dest: "{{ lookup('env', 'PWD') }}/inventory"
    state: link
