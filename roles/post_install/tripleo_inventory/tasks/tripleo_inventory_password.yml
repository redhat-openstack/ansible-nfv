---

- name: Generate and set an SSH key if password is used
  hosts: localhost
  tasks:
    - set_fact:
        tripleo_undercloud_key: "{{ environment_dir }}/id_rsa_{{ undercloud_host }}"
        
    - name: Delete the old ssh key if exists
      file:
        path: "{{ tripleo_undercloud_key }}"
        state: absent

    - name: Generate an SSH key
      command: ssh-keygen -b 4096 -N "" -C "TripleO Undercloud key" -f "/{{ tripleo_undercloud_key }}"

- name: Public key to undercloud
  hosts: undercloud
  vars:
    environment_dir: "{{ lookup('env', 'PWD') }}/inventories/{{ undercloud_host }}_env"
    tripleo_undercloud_key: "{{ environment_dir }}/id_rsa_{{ undercloud_host }}"
  tasks:
    - name: Load the public key to undercloud
      authorized_key:
        user: "{{ user | default('stack') }}"
        key: "{{ lookup('file', '{{ tripleo_undercloud_key }}.pub')}}"
        state: present

- name: Replace the Undercloud password with SSH key
  hosts: localhost
  vars:
    undercloud_host: "{{ host }}"
    undercloud_user: "{{ user | default('stack') }}"
    undercloud_private_key_file: "{{ tripleo_undercloud_key }}"
  tasks:
      # Flash in-memory inventory in order to recreate
      # the inventory file with the new parameters
    - meta: refresh_inventory

    - name: Add undercloud to host list
      add_host:
        name: "{{ undercloud_host }}"
        groups: "undercloud,tester"
        ansible_ssh_host: "{{ undercloud_host }}"
        ansible_ssh_user: "{{ undercloud_user }}"
        ansible_ssh_private_key_file: "{{ undercloud_private_key_file | default(omit) }}"

    - name: Generate Inventory file
      template:
        src: '../../../roles/post_install/tripleo_inventory/templates/inventory.j2'
        dest: "{{ environment_dir }}/inventory_{{ undercloud_host }}"
