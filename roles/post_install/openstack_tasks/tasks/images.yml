---
- name: Create images directory
  file:
    path: "{{ hypervisor_image_dir }}"
    state: directory
  delegate_to: hypervisor

- name: Download images
  get_url:
    url: "{{ item.url }}"
    dest: "{{ hypervisor_image_dir }}/{{ item.url | basename }}"
    validate_certs: "{{ image_valid_certs | default(False) }}"
    timeout: 100
  delegate_to: hypervisor
  retries: 3
  loop: "{{ images }}"

- name:  copy image from hypervisor to undercloud
  synchronize:
    src: "{{ hypervisor_image_dir }}/{{ item.url | basename }}"
    dest: "/tmp/{{ item.url | basename }}"
  delegate_to: hypervisor
  loop: "{{ images }}"

- name: Upload images
  vars:
    ansible_python_interpreter: "{{ venv_path }}/bin/python"
  os_image:
    cloud: "{{ item.cloud_name | default(cloud_name) }}"
    name: "{{ item.name }}"
    container_format: bare
    disk_format: qcow2
    state: present
    filename: "/tmp/{{ item.url | basename }}"
    is_public: yes
    properties:  "{{ item.properties|default({}) }}"
    validate_certs: "{{ validate_certs | default(omit) }}"
  loop: "{{ images }}"
