---

- name: "Projects {{ resource_state }}"
  vars:
    ansible_python_interpreter: "/tmp/ansible_venv/bin/python"
  os_project:
    cloud: "{{ overcloud_name }}"
    name: "{{ item.project }}"
    domain_id: "{{ item.domain }}"
    state: "{{ resource_state }}"
  with_items: "{{ users }}"

- name: "Users {{ resource_state }}"
  vars:
    ansible_python_interpreter: "/tmp/ansible_venv/bin/python"
  os_user:
    cloud: "{{ overcloud_name }}"
    name: "{{ item.name }}"
    password: "{{ item.pass }}"
    default_project: "{{ item.project }}"
    domain: "{{ item.domain }}"
    state: "{{ resource_state }}"
  with_items: "{{ users }}"
  register: reg_users

- name: Add user to role
  vars:
    ansible_python_interpreter: "/tmp/ansible_venv/bin/python"
  os_user_role:
    cloud: "{{ overcloud_name }}"
    user: "{{ item.name }}"
    project: "{{ item.project }}"
    role: "{{ item.role }}"
    state: "{{ resource_state }}"
  with_items: "{{ users }}"
  when: reg_users.changed and reg_users.results.0.user is defined
