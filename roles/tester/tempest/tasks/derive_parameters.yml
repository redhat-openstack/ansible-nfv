- name: Derive DPDK Parameters from TripleO Plan for OSP > 13
  block:
    - name: Stat deployment files
      stat:
        path: "{{ item }}"
      register: deployment_files_existence
      with_items:
        - "{{ network_environment_file }}"
        - "{{ roles_data_file }}"

    - name: Fail if deployment files not found
      fail:
        msg: "{{ item }} does not exist"
      with_items: "{{ deployment_files_existence.results }}"
      when: not item.stat.exists

    - name: Generate plan (derive DPDK parameters)
      shell: |
        openstack overcloud deploy --os-cloud {{ undercloud_name | default('undercloud') }} \
        --update-plan-only \
        --templates \
        -e {{ network_environment_file }} \
        -p /usr/share/openstack-tripleo-heat-templates/plan-samples/plan-environment-derived-params.yaml \
        -e /usr/share/openstack-tripleo-heat-templates/environments/network-isolation.yaml \
        -e /usr/share/openstack-tripleo-heat-templates/environments/neutron-ovs-dpdk.yaml \
        -r {{ roles_data_file }} | sed -n -e '/.*Parameters:/,/\n/p'
      register: derived_plan

    - name: Parse derived_plan
      set_fact:
        derived_plan: "{{ derived_plan.stdout | from_yaml }}"

    # Assumes that the compute role starts with "Compute..."
    - name: Discover role from derived plan
      set_fact:
        compute_role: "{{ derived_plan | sort | first }}"

    - name: Generate {{ derive_paramaters_json }}
      copy:
        content: "{{ derived_plan[compute_role] }}"
        dest: "{{ derive_paramaters_json }}"
