- name: Install packages inside guest image
  command: virt-customize -a {{ fetched_image }} --run-command "yum install {{ item }} -y" -v
  loop: 
      - git
      - gcc
      - make
      - cmake
      - gcc-c++
      - pciutils
      - glibc-devel
      - glibc-headers
      - numactl-devel
      - vim
      - tmux
      - python3
      - cloud-init
      # - "{{ user_packages | default("vim") }}"

# - name: Customize guest image with user-defined packages
#   virt_customize_package:
#     name: "{{ user_packages }}"
#     state: present
#     image: "{{ fetched_image }}"
#     selinux_relabel: True
#   when: user_packages is defined

# # - name: Customize users inside guest image
# #   virt_customize_user:
# #     name: "{{ item['user'] }}"
# #     password: "{{ item['password'] }}"
# #     state: present
# #     image: "{{ fetched_image }}"
# #   loop: "{{ custom_users }}"
# #   when: custom_users is defined

- name: copy cloud.cfg
  copy:
    src: cloud.cfg
    dest: "{{ guest_image_output }}"

- name: copy cloud-init cfg
  command: virt-copy-in -a {{ fetched_image }} "{{ guest_image_output }}/cloud.cfg" /etc/cloud/

# - name: Perform user-defined shell commands
#   virt_customize_command:
#     shell: "{{ user_commands }}"
#     image: "{{ fetched_image }}"
#     selinux_relabel: True
#   when: user_commands is defined
