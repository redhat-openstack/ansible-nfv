---
- name: Add port_security extenstion if extension_drivers exists
  lineinfile:
    dest: /etc/neutron/plugins/ml2/ml2_conf.ini
    backrefs: yes
    state: present
    regexp: 'extension_drivers.*=(?!.*port_security)(.*)'
    line: 'extension_drivers=\1,port_security'
  register: port_sec
  notify: Restart Neutron server

- name:
  ini_file:
    dest: /etc/neutron/plugins/ml2/ml2_conf.ini
    section: ml2
    option: extension_drivers
    value: port_security
  when: port_sec.changed == False

- meta: flush_handlers

- name: Restart Neutron server
  service: name=neutron-server state=restarted

- name: Set the external network port security
  shell: "source /root/keystonerc_admin && neutron net-update external --port_security_enabled=False"
