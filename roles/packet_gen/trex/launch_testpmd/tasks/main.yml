- name: Check If Tmux Sessions Are Running
  shell: "tmux list-sessions -F '#S'"
  register: tmux_sessions
  failed_when: False

- name: Kill Tmux Sessions
  shell: "tmux list-sessions -F '#S' | xargs -n1 tmux kill-session -t"
  when: tmux_sessions['stdout_lines'] != []

- name: Find node details
  set_fact:
    compute_index: "{{ item | int }}"
   when: "{{ dut_compute[item | int] in inventory_hostname }}"
   with_sequence: start=0 end={{ dut_compute | length - 1}} stride=1
 
- name: min and max dut_compute indexes
  set_face:
    dut_compute_min_index: 0
    dut_compute_max_index: "{{ dut_compute | length - 1 }}"

- name: Finds peer macs
  set_fact:
    peer_0: "{% if compute_index == dut_compute_min_index %}{{ hostvars[(groups['trex'] | first) ]['trex_instance_sriov_macs'][0] }}{% else%}{{  hostvars[groups[dut_group][compute_index-1]]['dut_macs'].split(',')[1]}}{% endif %}"
     peer_1: "{% if compute_index == dut_compute_max_index %}{{ hostvars[(groups['trex'] | first) ]['trex_instance_sriov_macs'][1] }}{% else%}{{  hostvars[groups[dut_group][compute_index+11]]['dut_macs'].split(',')[0]}}{% endif %}"

- name: Set TestPMD Command If Not Defined
  set_fact:
    testpmd_cmd: |
      {{ testpmd_bin }} -l {{ testpmd_lcores }} \
      --socket-mem {{ testpmd_socket_mem }} -- -i \
      --nb-cores={{ testpmd_forward_cores }} \
      --auto-start \
      {% if multiqueue_set is defined and multiqueue_set %}
        --rxq={{hostvars[dut_compute[compute_index]]['multiqueue']}} \
        --txq={{hostvars[dut_compute[compute_index]]['multiqueue']}} \
      {% endif %}
      {% if forward_mode == 'mac' %}
        --forward-mode=mac \
        --eth-peer=0,{{ peer_0 }} \
        --eth-peer=1,{{peer_1 }} \
      {% endif %}
      --rxd={{ testpmd_rxd }} \
      --txd={{ testpmd_txd }} &>/tmp/testpmd.log
  when: testpmd_cmd is not defined

- name: Log testpmd Command
  debug:
    var: testpmd_cmd

- name: Run testpmd In Dettached Tmux Session
  shell: |
    tmux new -d -s testpmd
    tmux send-keys -t testpmd "{{ testpmd_cmd }}" ENTER
    tmux send-keys -t testpmd "show port stats all" ENTER
  become: True

- name: Pause And Let TestPMD Run
  pause:
    seconds: 10

- name: Query If TestPMD Aborted
  slurp:
    src: '/tmp/testpmd.log'
  register: testpmd_log_output

- name: Print TestPMD Error
  fail:
    msg: "{{ testpmd_log_output['content'] | b64decode }}"
  failed_when: "'PANIC' in testpmd_log_output['content'] | b64decode"
