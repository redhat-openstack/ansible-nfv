- block:
    - name: Check if Trex Directory Exists
      stat:
        path: /opt/trex/current
      register: trex_dir_stat
      failed_when: not trex_dir_stat.stat.exists

    - name: Check if t-rex Processes are running
      shell: 'pgrep t-rex'
      register: trex_processes
      failed_when: False

    - name: Kill t-rex Processes
      shell: 'pkill t-rex'
      when: trex_processes['stdout_lines'] != []

    - name: Set t-rex command if not defined
      set_fact:
        trex_cmd: "{{ symlinked_trex_bin }} -i -c {{ trex_process_cores }} {{ trex_process_extra_args }} --cfg {{ trex_cfg }}"
      when: trex_cmd is not defined

    - name: Log t-rex command
      debug:
        var: trex_cmd

    - name: Run t-rex Traffic Generator In Background
      command: "screen -dmS trex -t server {{ trex_cmd }}"
      args:
        chdir: "{{ symlinked_trex_dir }}"
  delegate_to: "{{ trex_server_mgmt_ip }}"
