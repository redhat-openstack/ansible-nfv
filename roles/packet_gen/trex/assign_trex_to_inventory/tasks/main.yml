- name: Attempt To Discoer Floating IP Of Trex Server
  set_fact:
    trex_instance_mgmt_ip: "{{ openstack_servers[0]['addresses'][item] | selectattr('OS-EXT-IPS:type', 'equalto', 'floating') | map(attribute='addr') | list | first }}"
  loop: "{{ openstack_servers[0]['addresses'] | flatten(levels=1) }}"
  when:
    - openstack_servers[0]['addresses'][item] | selectattr('OS-EXT-IPS:type', 'equalto', 'floating') | list != []
    - trex_instance_mgmt_ip | default([]) == []

- name: Fail To Discover Trex Instance Management IP
  fail:
    msg: "Trex Instance Management IP can not be parsed"
  when: trex_instance_mgmt_ip == [] or trex_instance_mgmt_ip == "[Undefined]"

- name: Add Trex Instance To Ansible In-Memory Inventory
  add_host:
    name: "{{ trex_instance_mgmt_ip }}"
    groups: trex
    ansible_user: "{{ trex_instance_user | default('root') }}"
    ansible_password: "{{ trex_instance_password | default(omit) }}"
    ansible_ssh_private_key_file: "{{ trex_instance_ssh_key | default(omit) }}"
    ansible_ssh_pass: "{{ trex_instance_ssh_pass | default(omit) }}"

- name: Gather Facts From Trex Server
  setup:
  delegate_to: "{{ trex_instance_mgmt_ip }}"
  delegate_facts: True