- name: Clone trafficgen Project
  git:
    repo: 'https://github.com/atheurer/trafficgen'
    dest: '/opt/trafficgen'
  delegate_to: "{{ trex_server_mgmt_ip }}"

- name: Query DuT Instance Flow
  import_tasks: query_dut_instance.yml

# TODO: Proper print function
- name: Run Binary Search Script
  shell: "{{ traffic_cmd }}"
  delegate_to: "{{ trex_server_mgmt_ip }}"
  register: perf_output
  failed_when: False
  changed_when: False

- debug:
    var: perf_output

- name: Save Binary Search Script Result To File
  copy:
    content: "{{ perf_output['stdout'] }}"
    dest: /home/stack/PERF_LOG.log

- name: Parse JSON Result From Output File
  shell: "cat PERF_LOG.log  | sed -e '0,/RESULT/ d' | sed 's/\\[.*\\] //g' | jq ."
  register: perf_result
  when: perf_output['rc'] == 0

- name: Print Performance Result
  debug:
    msg: |
      t-rex command:
      {{ perf_output['cmd'] }}

      {% if perf_output.rc == 0 %}

      Performance Flow Succeded

      {% else %}

      Performance Flow Failed

      {% endif %}
  failed_when: perf_output['rc'] != 0
