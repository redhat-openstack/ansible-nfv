# NFV Performance - Trex

**NOTE** Automatic discovery is limited to two direct-physical ports attached to trex instance, more than two ports will require the user to pass configuration manually.

## Description
Prepares environment for NFV performance scenario using Trex:
  * Configure Trex instance

## Invocation

This playbooks can operate in two modes

### Create Cloud Resources
Resources are generated by this playbook via `roles/post_install/openstack_tasks` role, refer to the role's [documentation](https://github.com/redhat-openstack/ansible-nfv/blob/master/docs/tripleo/post_install/openstack_tasks.md).

Set the variable `cloud_resources` to 'create' and supply the required variables mentioned in the documentation linked above.

### Pre-existing Cloud Resources

TODO (vkhitrin): Add link to role documentation once agreed and merged.

Resources which already exist can be used in this playbook.

Leverages the `roles/post_install/dynamic_host_inventory` role in order to add existing instances to Ansible dynamic inventory.

Set the variable `cloud_resources` to `external` and supply the required variables mentioned.

## Role Variables

### Resources

Sets the execution mode (resource creation/resource querying), **not** defined by default.
```
cloud_resources: #'create' or 'external'
```

### Trex Configuration Variables

States if config variables should be parsed during run time, if `False`, a user must pass the required trex configuration variables.
```
dynamic_trex_conf: True
```

Trex configuration variables
```
trex_port_info: ['52:54:00:00:00', '52:54:00:00:00'] # Trex ports' MAC addresses
trex_cfg_version: 2 # Trex config version
trex_interfaces: ['00:03.0', '00:04.0'] # Trex interfaces PCI slots
trex_platform: # Additional Platform specific configuration/tuning
    master_thread_id: 2
    latency_thread_id: 3
    dual_if:
      - socket: 0
        threads: [4,5,6,7,8,9,10,11]
```

## Example
Examples of running this playbook:

### Create Cloud Resources

Sample variable file used `/path/to/openstack_task_vars.yml` (refer to the documentation mentioned above for more info):
```
---

# Tags
setup_os_env: true
user: false
net_port: true
flavor: true
network: true
image: true
instance: true
aggregate: true
resources_output: true
overcloud_name: overcloud

# User creation
users:
  - name: admin
    pass: ptBVnUnHR8AMNsy7E6MmeT6VA
    project: admin
    domain: default
    role: admin
    quota:
      - cores: 40

# Network creation
networks:
  - name: 'external_net_419'
    physical_network: 'dpdk-mgmt'
    segmentation_id: '419'
    allocation_pool_start: '10.35.185.19'
    allocation_pool_end: '10.35.185.28'
    cidr: '10.35.185.30/28'
    enable_dhcp: true
    gateway_ip: '10.35.185.30'
    network_type: vlan
    external: true
    shared: true
    router_name: router

  - name: 'management_net_530'
    allocation_pool_start: '10.10.130.10'
    allocation_pool_end: '10.10.130.200'
    cidr: '10.10.130.0/24'
    enable_dhcp: true
    gateway_ip: '10.10.130.254'
    network_type: vxlan
    external: false
    router_name: router

  - name: 'testpmd_net_nic0_700'
    physical_network: dpdk-data0
    segmentation_id: '700'
    allocation_pool_start: '70.0.0.100'
    allocation_pool_end: '70.0.0.200'
    cidr: '70.0.0.0/24'
    enable_dhcp: false
    gateway_ip: '70.0.0.254'
    network_type: vlan

  - name: 'testpmd_net_nic1_800'
    physical_network: dpdk-data1
    segmentation_id: '800'
    allocation_pool_start: '80.0.0.100'
    allocation_pool_end: '80.0.0.200'
    cidr: '80.0.0.0/24'
    enable_dhcp: false
    gateway_ip: '80.0.0.254'
    network_type: vlan

  - name: 'sriov_net_nic0_700'
    physical_network: sriov-1
    segmentation_id: '700'
    allocation_pool_start: '70.0.0.100'
    allocation_pool_end: '70.0.0.200'
    cidr: '70.0.0.0/24'
    enable_dhcp: false
    gateway_ip: '70.0.0.254'
    network_type: vlan

  - name: 'sriov_net_nic1_800'
    physical_network: sriov-2
    segmentation_id: '800'
    allocation_pool_start: '80.0.0.100'
    allocation_pool_end: '80.0.0.200'
    cidr: '80.0.0.0/24'
    enable_dhcp: false
    gateway_ip: '80.0.0.254'
    network_type: vlan

dns_nameservers:
  - 10.46.0.31
  - 8.8.8.8

# Aggregate group creation
aggregate_groups:
  - name: TREX_AG
    hosts:
      - compute-0.localdomain
    metadata:
      - flavor=trex_ag

  - name: DUT_AG
    hosts:
      - compute-1.localdomain
    metadata:
      - flavor=dut_ag

# Flavor creation
flavors:
  - name: perf_numa_0_trex
    ram: 8192
    disk: 20
    vcpus: 16
    extra_specs:
      - "hw:mem_page_size": "1GB"
        "hw:cpu_policy": "dedicated"
        "hw:numa_nodes": "1"
        "hw:numa_cpus.0": "0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15"
        "hw:numa_mem.0": "8192"
        "aggregate_instance_extra_specs:flavor": "trex_ag"

  - name: perf_numa_0_sriov_dut
    ram: 8192
    disk: 20
    vcpus: 16
    extra_specs:
      - "hw:mem_page_size": "1GB"
        "hw:cpu_policy": "dedicated"
        "hw:numa_nodes": "1"
        "hw:numa_cpus.0": "0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15"
        "hw:numa_mem.0": "8192"
        "aggregate_instance_extra_specs:flavor": "dut_ag"

  - name: perf_numa_1_dpdk_dut
    ram: 8192
    disk: 20
    vcpus: 8
    extra_specs:
      - "hw:mem_page_size": "1GB"
        "hw:cpu_policy": "dedicated"
        "hw:numa_nodes": "1"
        "hw:numa_cpus.1": "0,1,2,3,4,5,6,7"
        "hw:numa_mem.1": "8192"
        "aggregate_instance_extra_specs:flavor": "dut_ag"

# Image upload to the environment
images:
  - name: trex_testpmd
    url: http://file.tlv.redhat.com/~vkhitrin/rhel-guest-image-7.6-210.x86_64.qcow2

# Keypair creation for the ssh keyless access
keypair_name: test_keypair
resources_output_file: /home/stack/resources_output_file.yml

# Allow ICPM and SSH access to instances
security_groups:
  - name: test_secgroup
    rules:
      - protocol: icmp
        port_range_min: -1
        port_range_max: -1
        remote_ip_prefix: 0.0.0.0/0
      - protocol: tcp
        port_range_min: 22
        port_range_max: 22
        remote_ip_prefix: 0.0.0.0/0

# Instances creation
instances:
  - name: trex
    groups: trex
    flavor:  perf_numa_0_trex
    image: trex_testpmd
    key_name: "{{ keypair_name }}"
    sec_groups: test_secgroup
    config_drive: false
    floating_ip:
      ext_net: external_net_419
      int_net: management_net_530
    nics: net-name=management_net_530,port-name=sriov_net_nic0_700_trex_direct-physical_port-0,port-name=sriov_net_nic1_800_trex_direct-physical_port-1
    net_ports:
      - name: sriov_net_nic0_700_trex_direct-physical_port-0
        network: sriov_net_nic0_700
        port_security: false
        type: direct-physical
      - name: sriov_net_nic1_800_trex_direct-physical_port-1
        network: sriov_net_nic1_800
        port_security: false
        type: direct-physical
```

Generate Trex instance and configure it:
```
ansible-playbook playbooks/packet_gen/trex/performance_scenario.yml -e cloud_resources=create -e @/path/to/openstack_task_vars.yml
```

### Pre-existing Cloud Resources

TODO (vkhitrin): Add a mention to visit documentation once it's agreed and merged

Sample variable file used `/path/to/existing_resources.yml`:
```
discover_instance_external_ip: True
dynamic_instances:
  - name: trex
    group: trex
    user: cloud-user
    ssh_key: /tmp/test_keypair.key
ssh_key: /tmp/test_keypair.key
```

Configure pre-existing Trex instance:
```
ansible-playbook playbooks/packet_gen/trex/performance_scenario.yml -e cloud_resources=external -e @/path/to/existing_resources.yml
```