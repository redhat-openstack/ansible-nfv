# Guest Image Customization For Perfomance Usecases

## Description
The prepare_performance_images play performs the following tasks:
- Prepares repos for RHEL/CentOS 7 images
- Clones Trex from upstream repo to guest image
- Clones DPDK from upstream repo and compiles it

**Note!** - virt_customize moduless are planned to be shipped in this repo until they're available in PyPI
**Note!** - Inventory file is required, generated by `playbooks/tripleo/post_install/tripleo_inventory.yml`
**Note!** - DPDK is being complied without: rt-kni and igbuio support

* Repos
    * Fetches rhos-release tool from internal sources to generate repos for RHEL/CentOS images
* Prepare Tres
    * Clones Trex binaries from repo
* Prepare DPDK
    * Clones DPDK binaries from repo
    * Compiles DPDK binaries

## Run triggers
* prepare_trex - Executed if 'true'. False by default.
* prepare_dpdk - Executed if 'true'. False by default.
* prepare_repo - Executed if 'true'. False by default.

## Role variables
#### Image details
Path of image to be customized on underclound node
```
guest_image: /tmp/rhel75.qcow2
```

#### Customization variables
DPDK version to be cloned
```
dpdk_version: v17.05
```

Trex version to be cloned
```
trex_version: v2.43
```

OSP version to be used for rhos-release:
```
undercloud_version: 13
```

### Repo variables
Temporary directory to store repo file:
```
centos_repo_dir: '/tmp/guest_repos'
```

Repo name:
```
centos_repo_name: 'base'
```

Repo description:
```
centos_repo_description: 'CentOS-$releasever - Base'
```

Repo state:
```
centos_repo_state: 'present'
```

Repo mirrorlist:
```
centos_repo_mirrorlist: 'http://mirrorlist.centos.org/?release=7&arch=$basearch&repo=os'
```

Repo baseurl:
```
centos_repo_baseurl: 'http://mirror.centos.org/centos/7/os/$basearch/'
```

Repo gpgcheck:
```
centos_repo_gpgcheck: True
```

Repo gpgkey:
```
centos_repo_gpgkey: 'https://www.centos.org/keys/RPM-GPG-KEY-CentOS-7'
```

Output file of repo to be created:
```
centos_repo_file: "{{ centos_repo_dir }}/centos"
```

### DPDK Variables

Directory on guest image to clone DPDK repo to:
```
dpdk_dir: '/root/dpdk'
```

Log file for DPDK flow
```
dpdk_customization_log: '/root/dpdk/customization.log'
```

DPDK git URI:
```
dpdk_git: 'git://dpdk.org/dpdk'
```

### Trex Variables

Trex binaries URL:
```
trex_url: 'http://trex-tgn.cisco.com/trex/release'
```

Directory on guest to contain DPDK binaries in:
```
trex_dir: '/opt/trex/'
```

***
## Examples
The examples of running the playbook:

Generating CentOS repo for RHEL/CentOS:
```
ansible-playbook playbooks/images/prepare_performance_images.yml -e guest_image-'/path/to/image' -e prepare_dpdk=True
```

Installing DPDK inside guest image:
```
ansible-playbook playbooks/images/prepare_performance_images.yml -e guest_image-'/path/to/image' -e prepare_dpdk=True
```

Installing Trex inside guest image"
```
ansible-playbook playbooks/images/prepare_performance_images.yml -e guest_image-'/path/to/image' -e prepare_trex=True
```
