# Guest Image Customization For Perfomance Usecases

## Description
The prepare_performance_images play performs the following tasks:
- Prepares repos for RHEL/CentOS images (internal use only)
- Clones Trex from upstream repo to guest image
- Clones DPDK from upstream repo and compiles it

**Note!** - virt_customize moduless are planned to be shipped in this repo until they're available in PyPI
**Note!** - Inventory file is required, generated by `playbooks/tripleo/post_install/tripleo_inventory.yml`
**Note!** - Currently, [supermin](http://libguestfs.org/supermin.1.html) appliance is using the host's kernel thus DPDK compilation will require host's kernel to be present in image, a fix will be proposed later on.

* Repos
    * Fetches rhos-release tool from internal sources to generate repos for RHEL/CentOS images
* Prepare Tres
    * Clones Trex binaries from repo
* Prepare DPDK
    * Clones DPDK binaries from repo
    * Compiles DPDK binaries

## Run triggers
* prepare_trex - Executed if 'true'. False by default.
* prepare_dpdk - Executed if 'true'. False by default.

## Role variables
#### Image details
Path of image to be customized on underclound node
```
guest_image: /tmp/rhel75.qcow2
```

#### Customization variables
DPDK version to be cloned
```
dpdk_version: v17.05
```

Trex version to be cloned
```
trex_version: v2.43
```

**TODO(vkhitrin):** Add support for CentOS repositories
rhos-release RPM URL (available only internally)
```
rhos_release_rpm: 'http://rhos-release.virt.bos.redhat.com/repos/rhos-release/rhos-release-latest.noarch.rpm'
```

Directory on guest image to clone DPDK repo to:
```
dpdk_dir: '/root/dpdk'
```

Log file for DPDK flow
```
dpdk_customization_log: '/root/dpdk/customization.log'
```

DPDK git URI:
```
dpdk_git: 'git://dpdk.org/dpdk'
```

Trex binaries URL:
```
trex_url: 'http://trex-tgn.cisco.com/trex/release'
```

Directory on guest to contain DPDK binaries in:
```
trex_dir: '/opt/trex/'
```

***
## Examples
The examples of running the playbook:

```Installing DPDK inside guest image"
ansible-playbook playbooks/images/prepare_performance_images.yml -e guest_image-'/path/to/image' -e prepare_dpdk=True
```

```Installing Trex inside guest image"
ansible-playbook playbooks/images/prepare_performance_images.yml -e guest_image-'/path/to/image' -e prepare_trex=True
```
