# Guest Image Customization For Perfomance Usecases

## Description
The prepare_performance_images play performs the following tasks:
- Prepares repos for RHEL/CentOS 7 images
- Clones Trex from upstream repo to guest image
- Clones DPDK from upstream repo and compiles it

**Note!** - virt_customize moduless are planned to be shipped in this repo until they're available in PyPI
**Note!** - Inventory file is required, generated by `playbooks/tripleo/post_install/tripleo_inventory.yml`
**Note!** - DPDK is being complied without:
* [rt-kni](https://doc.dpdk.org/guides/prog_guide/kernel_nic_interface.html) - This feature allows DPDK to leverage it's user space capabilites for NICs bound to kernel, disabling it due to:
    * Requiring kernel modules during compilation, which will require additional logic for virt-customize
    * Not relevent to NFV-QE usecases
* [UIO](https://doc.dpdk.org/guides/linux_gsg/linux_drivers.html#uio) - Basic kernel module which configures the device, maps device mermory to user space and handles interrupts, disabling it due to:
    * Requiring kernel modules during compilation, which will require additional logic for virt-customize
    * Not relevent to NFV-QE usecases, we use vfio instead

* Repos
    * Uses CentOS public repos to customize RHEL/CentOS images
* Prepare Tres
    * Clones Trex binaries from repo
* Prepare DPDK
    * Clones DPDK binaries from repo
    * Compiles DPDK binaries

## Run triggers
* prepare_repo - Executed if 'true'. True by default.
* prepare_trex - Executed if 'true'. True by default.
* prepare_dpdk - Executed if 'true'. True by default.

## Role variables
#### Image details
URL of guest image to be downloaded
```
guest_image: 'https://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2'
```

Output directory/file of fetched image:
```
guest_image_output: '/tmp/'
```

#### Customization variables
DPDK version to be cloned
```
dpdk_version: v17.05
```

Trex version to be cloned
```
trex_version: v2.43
```

### Repo variables
Temporary directory to store repo file on host:
```
repo_dir: '/tmp/guest_repos'
```

List of repos to be created and uploaded to guest image:
```
guest_repos:
  - name: 'base'
    description: 'CentOS-$releasever - Base'
    state: 'present'
    mirrorlist: 'http://mirrorlist.centos.org/?release=7&arch=$basearch&repo=os'
    baseurl: 'http://mirror.centos.org/centos/7/os/$basearch/'
    gpgcheck: True
    gpgkey: 'https://www.centos.org/keys/RPM-GPG-KEY-CentOS-7'
    file: "{{ repo_dir }}/centos"
```

### DPDK Variables

Directory on guest image to clone DPDK repo to:
```
dpdk_dir: '/root/dpdk'
```

Log file for DPDK flow
```
dpdk_customization_log: '/root/dpdk/customization.log'
```

DPDK git URI:
```
dpdk_git: 'git://dpdk.org/dpdk'
```

### Trex Variables

Trex binaries URL:
```
trex_url: 'http://trex-tgn.cisco.com/trex/release'
```

Directory on guest to contain DPDK binaries in:
```
trex_dir: '/opt/trex/'
```

***
## Examples
The examples of running the playbook:

Generating CentOS repo for RHEL/CentOS:
```
ansible-playbook playbooks/images/prepare_performance_images.yml -e guest_image='/https://image.url' -e prepare_repo=
```

Installing DPDK inside guest image:
```
ansible-playbook playbooks/images/prepare_performance_images.yml -e guest_image='/https://image.url' -e prepare_dpdk=True
```

Installing Trex inside guest image"
```
ansible-playbook playbooks/images/prepare_performance_images.yml -e guest_image='/https://image.url' -e prepare_trex=True
```
