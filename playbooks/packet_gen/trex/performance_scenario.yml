---

- import_playbook: prepare_resources.yml

- hosts: "{{ dut_compute }}"
  become: true
  roles:
    - role: roles/packet_gen/trex/compute_tuning

- hosts: "{{ hci_group | default(omit) }}"
  roles:
    - role: roles/packet_gen/trex/launch_fio
      when: launch_hci_stress | default(False)|bool

- hosts: trex
  roles:
    - role: roles/packet_gen/trex/trex_instance_config
      when: trex_instance_config | default(True)|bool

- hosts: "{{ dut_group if dut_group else 'none' }}"
  become: true
  roles:
    - role: tuning/cpu_pinning_huge_pages
      vars:
        cpu_pinning_cores: "{{ testpmd_lcores }}"

- hosts: "{{ dut_group if dut_group else 'none' }}"
  roles:
    - role: roles/packet_gen/trex/bind_dpdk_nics
      vars:
        discover_dut_macs: True
        dpdk_binding_driver: "{{ dut_dpdk_binding_driver | default('vfio-pci') }}"
      when: bind_dpdk_nics | default(True)|bool

    - role: roles/packet_gen/trex/launch_testpmd
      when: launch_testpmd | default(True)|bool

- hosts: trex
  become: true
  roles:
    - role: tuning/cpu_pinning_huge_pages
      vars:
        cpu_pinning_cores: "{{ trex_lcores }}"

- hosts: trex
  roles:
    - role: roles/packet_gen/trex/bind_dpdk_nics
      vars:
        dpdk_binding_driver: "{{ trex_dpdk_binding_driver | default('vfio-pci') }}"
      when: bind_dpdk_nics | default(True)|bool

    - role: roles/packet_gen/trex/launch_trex
      when: launch_trex | default(True)|bool

    - role: roles/packet_gen/trex/binary_search
      when: binary_search | default(True)|bool
