---
- name: Common preparation
  hosts: "{{ dut_compute }}"
  pre_tasks:
    - name: Set directories path
      set_fact:
        logd: "/tmp/mq_tests_log/{{ multiqueue_test.name }}/log"
        yamld: "/tmp/mq_tests_log/{{ multiqueue_test.name }}/ansible"
        cfgd: "/tmp/mq_tests_log/{{ multiqueue_test.name }}/config"

    - name: Create required irectories on compute node
      file:
        path: "{{ item }}"
        state: directory
        recurse: True
      loop: "{{ [logd, yamld, cfgd] }}"

- name: Performs clean up
  hosts: "{{ dut_compute }}"
  become: true
  pre_tasks:
    - name: Check OSP version
      include_role:
        name: discover_osp_version

    - name: Set container type
      set_fact:
        container_type: "{% if overcloud_version | int <= 14 %}docker{% else %}podman{% endif %}"
    - name: Clean up existing pmd stats
      command: >
        ovs-appctl dpif-netdev/pmd-stats-clear

    - name: Disable multiqueue
      command: >
        ovs-vsctl remove Interface {{ dpdk_nic }} options n_rxq
      loop: "{{ dpdk_nics }}"
      loop_control:
        loop_var: dpdk_nic

    - name: Disable OvS PMD load balance
      openvswitch_db:
        table: open_vswitch
        record: .
        col: other_config
        key: pmd-auto-lb
        value: 'false'

    - name: Disable netcontrold pmd load balance
      command: >
        {{ container_type }} exec {{ ncd_container }} ncd_ctl stop
      ignore_errors: True

    - name: Removes the pmd rxq affinity config
      command: >
        ovs-vsctl remove Interface {{ dpdk_nic }} other_config pmd-rxq-affinity
      loop: "{{ dpdk_nics }}"
      loop_control:
        loop_var: dpdk_nic

    - name: Removes netcontrold logs
      file:
        path: /var/log/netcontrold*
        state: absent
      ignore_errors: True

- name: PMD Configs
  hosts: "{{ dut_compute }}"
  become: true
  pre_tasks:
    - name: PMD configs
      openvswitch_db:
        table: open_vswitch
        record: .
        col: other_config
        key: pmd-cpu-mask
        value: "{{ multiqueue_test.pmd_mask }}"

- name: Update trex and dut flavors and instances
  hosts: undercloud
  pre_tasks:
    - name: Update trex flavor cpus
      set_fact:
        updated_flavors: "{{ [flavor | combine({'extra_specs': trex_extra_specs}, recursive=true) | combine(trex_vcpus, recursive=true)] }}"
      vars:
        trex_extra_specs: "{{ flavor.extra_specs | combine({ 'hw:numa_cpus.0': multiqueue_test.get('trex', {}).get('hw_numa_cpus','') }) }}"
        trex_vcpus: "{'vcpus': {{ multiqueue_test.get('trex', {}).get('vcpus', 6) }} }"
      when:
        - flavor.name == 'trex'
      loop: "{{ multiqueue_flavors }}"
      loop_control:
        loop_var: flavor

    - name: Update testpmd flavors cpus
      set_fact:
        updated_flavors: "{{ updated_flavors | default([]) }} + {{ [flavor | combine({'extra_specs': testpmd_extra_specs}, recursive=true) | combine(testpmd_vcpus, recursive=true)] }}"
      vars:
        testpmd_extra_specs: "{{ flavor.extra_specs | combine({ 'hw:numa_cpus.0': multiqueue_test.get('testpmd', {}).get('hw_numa_cpus','') }) }}"
        testpmd_vcpus: "{'vcpus': {{ multiqueue_test.get('testpmd', {}).get('vcpus', 4) }} }"
      when:
        - flavor.name != 'trex'
      loop: "{{ multiqueue_flavors }}"
      loop_control:
        loop_var: flavor

    - name: Gets trex instance
      set_fact:
        updated_instances: "{{ [instance] }}"
      when:
        - instance.name == 'trex'
      loop: "{{ multiqueue_instances }}"
      loop_control:
        loop_var: instance

    - name: Update testpmd instances with required image
      set_fact:
        updated_instances: "{{ updated_instances | default([]) }} + {{ [instance | combine({'image': multiqueue_test.testpmd_image}, recursive=true)] }}"
      when:
        - instance.name != 'trex'
      loop: "{{ multiqueue_instances }}"
      loop_control:
        loop_var: instance

- name: Collect ovs configs
  hosts: "{{ dut_compute }}"
  become: true
  pre_tasks:
    - block:
        - name: Collect ovs configs
          shell: >
            ovs-vsctl list Open_vSwitch >{{ cfgd }}/ovs_config

        - name: Collect ovs status
          shell: >
            ovs-vsctl show >{{ cfgd }}/ovs_status

        - name: Collect ovs version
          shell: >
            ovs-vswitchd -V >{{ logd }}/ovs_version

        - name: Collect ovs multiqueue details
          shell: >
            ovs-appctl dpif-netdev/pmd-rxq-show >{{ logd }}/ovs-appctl_pmd-rxq-show
      when:
        - multiqueue_test.pmd_lb is defined
        - multiqueue_test.pmd_lb in ['ovs']

- name: Collect netcontrold configs
  hosts: "{{ dut_compute }}"
  become: true
  pre_tasks:
    - block:
        - name: Start netcontrold
          command: >
            {{ container_type }} exec {{ ncd_container }} ncd_ctl start
          ignore_errors: True

        - name: Collect netcontrold configs
          shell: >
            {{ container_type }} exec {{ ncd_container }} ncd_ctl config show >{{ cfgd }}/ncd_config
          ignore_errors: True

        - name: Collect netcontrold version
          shell: >
            {{ container_type }} exec {{ ncd_container }} ncd_ctl version >{{ cfgd }}/ncd_version
          ignore_errors: True
      when:
        - multiqueue_test.pmd_lb is defined
        - multiqueue_test.pmd_lb in ['user']

- name: Update multiqueue status
  hosts: "{{ dut_compute }}"
  become: true
  pre_tasks:
    - name: Disable multiqueue for DPDK ports if multiqueue is not required
      command: >
        ovs-vsctl remove Interface {{ dpdk_nic }} options n_rxq
      loop: "{{ dpdk_nics }}"
      loop_control:
        loop_var: dpdk_nic
      when:
        - not multiqueue_test.multiqueue_set

    - name: Enable multiqueue for DPDK ports if multiqueue is required
      openvswitch_db:
        table: Interface
        record: "{{ dpdk_nic }}"
        col: options
        key: n_rxq
        value: "{{ multiqueue_test.queue_count }}"
      loop: "{{ dpdk_nics }}"
      loop_control:
        loop_var: dpdk_nic
      when:
        - multiqueue_test.multiqueue_set

- name: Create required directories on undercloud
  hosts: undercloud
  pre_tasks:
    - name: Create test result log directory on undercloud
      file:
        path: "/tmp/mq_perf_results/{{ multiqueue_test.name }}"
        state: directory
        recurse: True

- name: Run multiqueue performance
  import_playbook: performance_scenario.yml
  vars:
    resource_state: present
    instances: "{{ updated_instances }}"
    flavors: "{{ updated_flavors }}"
    pmd_lb: "{{ multiqueue_test.pmd_lb }}"
    multiqueue_set: "{{ multiqueue_test.multiqueue_set }}"
    testpmd_lcores: "{{ multiqueue_test.get('testpmd', {}).get('lcores', '') }}"
    testpmd_forward_cores: "{{ multiqueue_test.get('testpmd', {}).get('forward_cores', 2) }}"
    trex_lcores: "{{ multiqueue_test.get('trex', {}).get('lcores', '') }}"
    trex_rate: "{{ multiqueue_test.get('trex', {}).get('rate', 2) }}"
    trex_process_threads: "{{ multiqueue_test.get('trex', {}).get('process_threads', 2) }}"
    trex_platform:  "{{ multiqueue_test.get('trex', {}).get('platform', {}) }}"
    binary_perf_log: "/tmp/mq_perf_results/{{ multiqueue_test.name }}/dpdk_performance.log"

- name: Openstack resources clean up
  hosts: "{{ osp_tasks_host | default('undercloud') }}"
  gather_facts: False
  roles:
    - post_install/openstack_tasks
  vars:
    resource_state: absent
    instances: "{{ updated_instances }}"
    flavors: "{{ updated_flavors }}"
