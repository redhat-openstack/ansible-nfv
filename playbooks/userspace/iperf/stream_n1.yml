---
- hosts: undercloud
  gather_facts: False
  pre_tasks:
    - name: Require Resource Method
      fail:
        msg: "cloud_resources is not set to correct values: 'create' or 'external', please refer to documentation"
      when: cloud_resources is not defined or cloud_resources not in ['create', 'external']

    - block:
        - name: Generate Resources
          import_role:
            name: roles/post_install/openstack_tasks

        # Workaround for adding generated instances to dynamic inventory
        - meta: refresh_inventory

        - name: Map Instances To Helper Variable
          set_fact:
            generated_instances: >-
              {{ generated_instances | default([]) }} + [{'name': '{{ item['name'] }}',
              'group': '{{ item['groups'] }}',
              'user': '{{ connection_user }}',
              'ssh_key': '/tmp/{{ item['key_name'] }}.key' }]
          loop: "{{ instances }}"

        - name: Workaround - Add Generated Instances To Dynamic Inventory
          include_role:
            name: roles/post_install/dynamic_host_inventory
          vars:
            discover_instance_external_ip: True
          loop: "{{ generated_instances }}"
      when: cloud_resources == 'create'

    - name: Use Pre-exisisting Resources
      block:
        - name: Prepare Virtual Environment
          include_role:
            name: roles/post_install/openstack_tasks
            tasks_from: setup_openstack_env

        - name: Add Pre-existing Instances To Dynamic Inventory
          include_role:
            name: roles/post_install/dynamic_host_inventory
          loop: "{{ dynamic_instances }}"
      when: cloud_resources == 'external'

- hosts: "{{ dut_compute }}"
  become: true
  roles:
    - role: roles/packet_gen/trex/compute_tuning

- hosts: "{{ dut_group }}"
  become: true
  roles:
    - role: tuning/cpu_pinning_huge_pages
      vars:
        cpu_pinning_cores: "{{ iperf_lcores }}"

- hosts: "{{ groups[dut_group][0] }}"
  roles:
    - role: roles/userspace/iperf/server
      when: iperf_server | default(True)

- hosts: "{{ groups[dut_group][1] }}"
  roles:
    - role: roles/userspace/iperf/client
      when: iperf_client | default(True)
